<!DOCTYPE html><html><head><title>annotate.coffee</title><meta http-equiv="Content-Type" content="text/html" charset="UTF-8"><link rel="stylesheet" media="all" href="../docco.css"></head><body><div id="container"><div id="background"></div><div id="jump_to">Jump To &hellip;<div id="jump_wrapper"><div id="jump_page"><a href="../index.html" class="source"><span class="file_name">README</span></a><a href="../src/annotate.coffee.html" class="source selected"><span class="base_path">src / </span><span class="file_name">annotate.coffee</span></a><a href="../src/annotationInteraction.coffee.html" class="source "><span class="base_path">src / </span><span class="file_name">annotationInteraction.coffee</span></a><a href="../src/annotationSelector.coffee.html" class="source "><span class="base_path">src / </span><span class="file_name">annotationSelector.coffee</span></a><a href="../src/stanbolEnhancementAPI.coffee.html" class="source "><span class="base_path">src / </span><span class="file_name">stanbolEnhancementAPI.coffee</span></a><a href="../src/vie.autocomplete.coffee.html" class="source "><span class="base_path">src / </span><span class="file_name">vie.autocomplete.coffee</span></a></div></div></div><table cellpadding="0" cellspacing="0"><thead><tr><th class="docs"><h1>annotate.coffee</h1><div class="filepath">src/</div></th><th class="code"></th></tr></thead><tbody><tr id="section-1"><td class="docs"><div class="pilwrap"><a href="#section-1" class="pilcrow">&#182;</a></div><h2>Annotate - a text enhancement interaction jQuery UI widget</h2>

<pre><code>(c) 2011 Szaby Gruenwald, IKS Consortium
Annotate may be freely distributed under the MIT license
</code></pre>

<h1>#</h1>

<p>define namespaces</p>
</td><td class="code"><div class="highlight"><pre><span class="nv">ns =</span>
    <span class="nv">rdf: </span>     <span class="s">&#39;http://www.w3.org/1999/02/22-rdf-syntax-ns#&#39;</span>
    <span class="nv">enhancer: </span><span class="s">&#39;http://fise.iks-project.eu/ontology/&#39;</span>
    <span class="nv">dcterms: </span> <span class="s">&#39;http://purl.org/dc/terms/&#39;</span>
    <span class="nv">rdfs: </span>    <span class="s">&#39;http://www.w3.org/2000/01/rdf-schema#&#39;</span>
    <span class="nv">skos: </span>    <span class="s">&#39;http://www.w3.org/2004/02/skos/core#&#39;</span>

<span class="nv">root = </span><span class="k">this</span>
<span class="nv">jQuery = </span><span class="nx">root</span><span class="p">.</span><span class="nx">jQuery</span>
<span class="nv">Backbone = </span><span class="nx">root</span><span class="p">.</span><span class="nx">Backbone</span>
<span class="nv">_ = </span><span class="nx">root</span><span class="p">.</span><span class="nx">_</span>
<span class="nv">VIE = </span><span class="nx">root</span><span class="p">.</span><span class="nx">VIE</span>

<span class="nv">vie = </span><span class="k">new</span> <span class="nx">VIE</span><span class="p">()</span>
<span class="nx">vie</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="k">new</span> <span class="nx">vie</span><span class="p">.</span><span class="nx">StanbolService</span><span class="p">({</span>
    <span class="nv">url : </span><span class="s">&quot;http://dev.iks-project.eu:8080&quot;</span><span class="p">,</span>
    <span class="nv">proxyDisabled: </span><span class="kc">true</span>
<span class="p">}));</span>
<span class="nx">vie</span><span class="p">.</span><span class="nx">namespaces</span><span class="p">.</span><span class="nx">add</span> <span class="s">&quot;skos&quot;</span><span class="p">,</span> <span class="nx">ns</span><span class="p">.</span><span class="nx">skos</span></pre></div></td></tr><tr id="section-2"><td class="docs"><div class="pilwrap"><a href="#section-2" class="pilcrow">&#182;</a></div><p>In Internet Explorer String.trim is not defined but we're going to use it.</p>
</td><td class="code"><div class="highlight"><pre><span class="nb">String</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">trim</span> <span class="o">?=</span> <span class="o">-&gt;</span>
    <span class="nx">@replace</span> <span class="sr">/^\s+|\s+$/g</span><span class="p">,</span> <span class="s">&#39;&#39;</span></pre></div></td></tr><tr id="section-3"><td class="docs"><div class="pilwrap"><a href="#section-3" class="pilcrow">&#182;</a></div><p>calling the get with a scope and callback will call cb(entity) with the scope as soon it's available.'</p>
</td><td class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nx">EntityCache</span>
    <span class="nv">constructor: </span><span class="nf">(opts) -&gt;</span>
        <span class="vi">@vie = </span><span class="nx">opts</span><span class="p">.</span><span class="nx">vie</span>
        <span class="vi">@logger = </span><span class="nx">opts</span><span class="p">.</span><span class="nx">logger</span>
    <span class="nv">_entities: </span><span class="o">-&gt;</span> <span class="nb">window</span><span class="p">.</span><span class="nx">entityCache</span> <span class="o">?=</span> <span class="p">{}</span>
    <span class="nv">get: </span><span class="nf">(uri, scope, success, error) -&gt;</span>
        <span class="nv">uri = </span><span class="nx">uri</span><span class="p">.</span><span class="nx">replace</span> <span class="sr">/^&lt;|&gt;$/g</span><span class="p">,</span> <span class="s">&quot;&quot;</span></pre></div></td></tr><tr id="section-4"><td class="docs"><div class="pilwrap"><a href="#section-4" class="pilcrow">&#182;</a></div><p>If entity is stored in the cache already just call cb</p>
</td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="nx">@_entities</span><span class="p">()[</span><span class="nx">uri</span><span class="p">]</span> <span class="o">and</span> <span class="nx">@_entities</span><span class="p">()[</span><span class="nx">uri</span><span class="p">].</span><span class="nx">status</span> <span class="o">is</span> <span class="s">&quot;done&quot;</span>
            <span class="k">if</span> <span class="k">typeof</span> <span class="nx">success</span> <span class="o">is</span> <span class="s">&quot;function&quot;</span>
                <span class="nx">success</span><span class="p">.</span><span class="nx">apply</span> <span class="nx">scope</span><span class="p">,</span> <span class="p">[</span><span class="nx">@_entities</span><span class="p">()[</span><span class="nx">uri</span><span class="p">].</span><span class="nx">entity</span><span class="p">]</span>
        <span class="k">else</span> <span class="k">if</span> <span class="nx">@_entities</span><span class="p">()[</span><span class="nx">uri</span><span class="p">]</span> <span class="o">and</span> <span class="nx">@_entities</span><span class="p">()[</span><span class="nx">uri</span><span class="p">].</span><span class="nx">status</span> <span class="o">is</span> <span class="s">&quot;error&quot;</span>
            <span class="k">if</span> <span class="k">typeof</span> <span class="nx">error</span> <span class="o">is</span> <span class="s">&quot;function&quot;</span>
                <span class="nx">error</span><span class="p">.</span><span class="nx">apply</span> <span class="nx">scope</span><span class="p">,</span> <span class="p">[</span><span class="s">&quot;error&quot;</span><span class="p">]</span></pre></div></td></tr><tr id="section-5"><td class="docs"><div class="pilwrap"><a href="#section-5" class="pilcrow">&#182;</a></div><p>If the entity is new to the cache</p>
</td><td class="code"><div class="highlight"><pre>        <span class="k">else</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">@_entities</span><span class="p">()[</span><span class="nx">uri</span><span class="p">]</span></pre></div></td></tr><tr id="section-6"><td class="docs"><div class="pilwrap"><a href="#section-6" class="pilcrow">&#182;</a></div><p>create cache entry</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">@_entities</span><span class="p">()[</span><span class="nx">uri</span><span class="p">]</span> <span class="o">=</span> 
                <span class="nv">status: </span><span class="s">&quot;pending&quot;</span>
                <span class="nv">uri: </span><span class="nx">uri</span>
            <span class="nv">cache = </span><span class="nx">@</span></pre></div></td></tr><tr id="section-7"><td class="docs"><div class="pilwrap"><a href="#section-7" class="pilcrow">&#182;</a></div><p>make a request to the entity hub</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">@vie</span><span class="p">.</span><span class="nx">load</span><span class="p">({</span><span class="nv">entity: </span><span class="nx">uri</span><span class="p">}).</span><span class="nx">using</span><span class="p">(</span><span class="s">&#39;stanbol&#39;</span><span class="p">).</span><span class="nx">execute</span><span class="p">().</span><span class="nx">success</span> <span class="p">(</span><span class="nx">entityArr</span><span class="p">)</span> <span class="o">=&gt;</span>
                <span class="nx">_</span><span class="p">.</span><span class="nx">defer</span> <span class="o">=&gt;</span>
                    <span class="nv">cacheEntry = </span><span class="nx">@_entities</span><span class="p">()[</span><span class="nx">uri</span><span class="p">]</span>
                    <span class="nv">entity = </span><span class="nx">_</span><span class="p">.</span><span class="nx">detect</span> <span class="nx">entityArr</span><span class="p">,</span> <span class="nf">(e) -&gt;</span>
                        <span class="kc">true</span> <span class="k">if</span> <span class="nx">e</span><span class="p">.</span><span class="nx">getSubject</span><span class="p">()</span> <span class="o">is</span> <span class="s">&quot;&lt;</span><span class="si">#{</span><span class="nx">uri</span><span class="si">}</span><span class="s">&gt;&quot;</span>
                    <span class="k">if</span> <span class="nx">entity</span>
                        <span class="nv">cacheEntry.entity = </span><span class="nx">entity</span>
                        <span class="nv">cacheEntry.status = </span><span class="s">&quot;done&quot;</span>
                        <span class="nx">$</span><span class="p">(</span><span class="nx">cacheEntry</span><span class="p">).</span><span class="nx">trigger</span> <span class="s">&quot;done&quot;</span><span class="p">,</span> <span class="nx">entity</span>
                    <span class="k">else</span>
                        <span class="nx">@logger</span><span class="p">.</span><span class="nx">warn</span> <span class="s">&quot;couldn&#39;&#39;t load </span><span class="si">#{</span><span class="nx">uri</span><span class="si">}</span><span class="s">&quot;</span><span class="p">,</span> <span class="nx">entityArr</span>
                        <span class="nv">cacheEntry.status = </span><span class="s">&quot;not found&quot;</span>
            <span class="p">.</span><span class="nx">fail</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="o">=&gt;</span>
                <span class="nx">_</span><span class="p">.</span><span class="nx">defer</span> <span class="o">=&gt;</span>
                    <span class="nx">@logger</span><span class="p">.</span><span class="nx">error</span> <span class="s">&quot;couldn&#39;t load </span><span class="si">#{</span><span class="nx">uri</span><span class="si">}</span><span class="s">&quot;</span>
                    <span class="nv">cacheEntry = </span><span class="nx">@_entities</span><span class="p">()[</span><span class="nx">uri</span><span class="p">]</span>
                    <span class="nv">cacheEntry.status = </span><span class="s">&quot;error&quot;</span>
                    <span class="nx">$</span><span class="p">(</span><span class="nx">cacheEntry</span><span class="p">).</span><span class="nx">trigger</span> <span class="s">&quot;fail&quot;</span><span class="p">,</span> <span class="nx">e</span>

        <span class="k">if</span> <span class="nx">@_entities</span><span class="p">()[</span><span class="nx">uri</span><span class="p">]</span> <span class="o">and</span> <span class="nx">@_entities</span><span class="p">()[</span><span class="nx">uri</span><span class="p">].</span><span class="nx">status</span> <span class="o">is</span> <span class="s">&quot;pending&quot;</span>
            <span class="nx">$</span><span class="p">(</span> <span class="nx">@_entities</span><span class="p">()[</span><span class="nx">uri</span><span class="p">]</span> <span class="p">)</span>
            <span class="p">.</span><span class="nx">bind</span> <span class="s">&quot;done&quot;</span><span class="p">,</span> <span class="nf">(event, entity) -&gt;</span>
                <span class="k">if</span> <span class="k">typeof</span> <span class="nx">success</span> <span class="o">is</span> <span class="s">&quot;function&quot;</span>
                    <span class="nx">success</span><span class="p">.</span><span class="nx">apply</span> <span class="nx">scope</span><span class="p">,</span> <span class="p">[</span><span class="nx">entity</span><span class="p">]</span>
            <span class="p">.</span><span class="nx">bind</span> <span class="s">&quot;fail&quot;</span><span class="p">,</span> <span class="nf">(event, error) -&gt;</span>
                <span class="k">if</span> <span class="k">typeof</span> <span class="nx">error</span> <span class="o">is</span> <span class="s">&quot;function&quot;</span>
                    <span class="nx">error</span><span class="p">.</span><span class="nx">apply</span> <span class="nx">scope</span><span class="p">,</span> <span class="p">[</span><span class="nx">error</span><span class="p">]</span></pre></div></td></tr><tr id="section-8"><td class="docs"><div class="pilwrap"><a href="#section-8" class="pilcrow">&#182;</a></div><p>Give back the last part of a uri for fallback label creation</p>
</td><td class="code"><div class="highlight"><pre><span class="nv">uriSuffix = </span><span class="nf">(uri) -&gt;</span>
    <span class="nv">res = </span><span class="nx">uri</span><span class="p">.</span><span class="nx">substring</span> <span class="nx">uri</span><span class="p">.</span><span class="nx">lastIndexOf</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">substring</span> <span class="nx">res</span><span class="p">.</span><span class="nx">lastIndexOf</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span></pre></div></td></tr><tr id="section-9"><td class="docs"><div class="pilwrap"><a href="#section-9" class="pilcrow">&#182;</a></div><h6>#</h6>

<p>Annotate widget
makes a content dom element interactively annotatable</p>

<h6>#</h6>
</td><td class="code"><div class="highlight"><pre><span class="nx">jQuery</span><span class="p">.</span><span class="nx">widget</span> <span class="s">&#39;IKS.annotate&#39;</span><span class="p">,</span>
    <span class="nv">__widgetName: </span><span class="s">&quot;IKS.annotate&quot;</span>
    <span class="nv">options:</span></pre></div></td></tr><tr id="section-10"><td class="docs"><div class="pilwrap"><a href="#section-10" class="pilcrow">&#182;</a></div><p>VIE instance to use for (backend) enhancement</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nv">vie: </span><span class="nx">vie</span>
        <span class="nv">vieServices: </span><span class="p">[</span><span class="s">&quot;stanbol&quot;</span><span class="p">]</span></pre></div></td></tr><tr id="section-11"><td class="docs"><div class="pilwrap"><a href="#section-11" class="pilcrow">&#182;</a></div><p>Do analyze on instantiation</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nv">autoAnalyze: </span><span class="kc">false</span></pre></div></td></tr><tr id="section-12"><td class="docs"><div class="pilwrap"><a href="#section-12" class="pilcrow">&#182;</a></div><p>Keeps continouosly checking in the background, while typing</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nv">continuousChecking: </span><span class="kc">false</span></pre></div></td></tr><tr id="section-13"><td class="docs"><div class="pilwrap"><a href="#section-13" class="pilcrow">&#182;</a></div><p>Wait for some time (in ms) for the user not typing, before it starts analyzing.</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nv">throttleDistance: </span><span class="mi">5000</span></pre></div></td></tr><tr id="section-14"><td class="docs"><div class="pilwrap"><a href="#section-14" class="pilcrow">&#182;</a></div><p>Tooltip can be disabled</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nv">showTooltip: </span><span class="kc">true</span></pre></div></td></tr><tr id="section-15"><td class="docs"><div class="pilwrap"><a href="#section-15" class="pilcrow">&#182;</a></div><p>Debug can be enabled</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nv">debug: </span><span class="kc">false</span></pre></div></td></tr><tr id="section-16"><td class="docs"><div class="pilwrap"><a href="#section-16" class="pilcrow">&#182;</a></div><p>Define Entity properties for finding depiction</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nv">depictionProperties: </span><span class="p">[</span>
            <span class="s">&quot;foaf:depiction&quot;</span>
            <span class="s">&quot;schema:thumbnail&quot;</span>
        <span class="p">]</span></pre></div></td></tr><tr id="section-17"><td class="docs"><div class="pilwrap"><a href="#section-17" class="pilcrow">&#182;</a></div><p>Lookup for a label will inspect these properties of an entity</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nv">labelProperties: </span><span class="p">[</span>
            <span class="s">&quot;rdfs:label&quot;</span>
            <span class="s">&quot;skos:prefLabel&quot;</span>
            <span class="s">&quot;schema:name&quot;</span>
            <span class="s">&quot;foaf:name&quot;</span>
        <span class="p">]</span></pre></div></td></tr><tr id="section-18"><td class="docs"><div class="pilwrap"><a href="#section-18" class="pilcrow">&#182;</a></div><p>Lookup for a description will inspect these properties of an entity</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nv">descriptionProperties: </span><span class="p">[</span>
            <span class="s">&quot;rdfs:comment&quot;</span>
            <span class="s">&quot;skos:note&quot;</span>
            <span class="s">&quot;schema:description&quot;</span>
            <span class="s">&quot;skos:definition&quot;</span>
                <span class="nv">property: </span><span class="s">&quot;skos:broader&quot;</span>
                <span class="nv">makeLabel: </span><span class="nf">(propertyValueArr) -&gt;</span>
                    <span class="nv">labels = </span><span class="nx">_</span><span class="p">(</span><span class="nx">propertyValueArr</span><span class="p">).</span><span class="nx">map</span> <span class="nf">(termUri) -&gt;</span></pre></div></td></tr><tr id="section-19"><td class="docs"><div class="pilwrap"><a href="#section-19" class="pilcrow">&#182;</a></div><p>extract the last part of the uri</p>
</td><td class="code"><div class="highlight"><pre>                        <span class="nx">termUri</span>
                        <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&lt;.*[\/#](.*)&gt;/</span><span class="p">,</span> <span class="s">&quot;$1&quot;</span><span class="p">)</span>
                        <span class="p">.</span><span class="nx">replace</span> <span class="sr">/_/g</span><span class="p">,</span> <span class="s">&quot;&amp;nbsp;&quot;</span>
                    <span class="s">&quot;Subcategory of </span><span class="si">#{</span><span class="nx">labels</span><span class="p">.</span><span class="nx">join</span> <span class="s">&#39;, &#39;</span><span class="si">}</span><span class="s">.&quot;</span>
            <span class="p">,</span>
                <span class="nv">property: </span><span class="s">&quot;dcterms:subject&quot;</span>
                <span class="nv">makeLabel: </span><span class="nf">(propertyValueArr) -&gt;</span>
                    <span class="nv">labels = </span><span class="nx">_</span><span class="p">(</span><span class="nx">propertyValueArr</span><span class="p">).</span><span class="nx">map</span> <span class="nf">(termUri) -&gt;</span></pre></div></td></tr><tr id="section-20"><td class="docs"><div class="pilwrap"><a href="#section-20" class="pilcrow">&#182;</a></div><p>extract the last part of the uri</p>
</td><td class="code"><div class="highlight"><pre>                        <span class="nx">termUri</span>
                        <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&lt;.*[\/#](.*)&gt;/</span><span class="p">,</span> <span class="s">&quot;$1&quot;</span><span class="p">)</span>
                        <span class="p">.</span><span class="nx">replace</span> <span class="sr">/_/g</span><span class="p">,</span> <span class="s">&quot;&amp;nbsp;&quot;</span>
                    <span class="s">&quot;Subject(s): </span><span class="si">#{</span><span class="nx">labels</span><span class="p">.</span><span class="nx">join</span> <span class="s">&#39;, &#39;</span><span class="si">}</span><span class="s">.&quot;</span>
        <span class="p">]</span></pre></div></td></tr><tr id="section-21"><td class="docs"><div class="pilwrap"><a href="#section-21" class="pilcrow">&#182;</a></div><p>If label and description is not available in the user's language 
look for a fallback.</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nv">fallbackLanguage: </span><span class="s">&quot;en&quot;</span></pre></div></td></tr><tr id="section-22"><td class="docs"><div class="pilwrap"><a href="#section-22" class="pilcrow">&#182;</a></div><p>namespaces necessary for the widget configuration</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nv">ns:</span>
            <span class="nv">dbpedia: </span> <span class="s">&quot;http://dbpedia.org/ontology/&quot;</span>
            <span class="nv">skos: </span>    <span class="s">&quot;http://www.w3.org/2004/02/skos/core</span><span class="err">#</span><span class="s">&quot;</span></pre></div></td></tr><tr id="section-23"><td class="docs"><div class="pilwrap"><a href="#section-23" class="pilcrow">&#182;</a></div><p>List of enhancement types to filter for</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nv">typeFilter: </span><span class="kc">null</span>
        <span class="nv">annotationInteractionWidget: </span><span class="s">&quot;annotationInteraction&quot;</span></pre></div></td></tr><tr id="section-24"><td class="docs"><div class="pilwrap"><a href="#section-24" class="pilcrow">&#182;</a></div><p>Give a label to your expected enhancement types</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nv">getTypes: </span><span class="o">-&gt;</span>
            <span class="p">[</span>
                <span class="nv">uri: </span>  <span class="s">&quot;</span><span class="si">#{</span><span class="nx">@ns</span><span class="p">.</span><span class="nx">dbpedia</span><span class="si">}</span><span class="s">Place&quot;</span>
                <span class="nv">label: </span><span class="s">&#39;Place&#39;</span>
            <span class="p">,</span>
                <span class="nv">uri: </span>  <span class="s">&quot;</span><span class="si">#{</span><span class="nx">@ns</span><span class="p">.</span><span class="nx">dbpedia</span><span class="si">}</span><span class="s">Person&quot;</span>
                <span class="nv">label: </span><span class="s">&#39;Person&#39;</span>
            <span class="p">,</span>
                <span class="nv">uri: </span>  <span class="s">&quot;</span><span class="si">#{</span><span class="nx">@ns</span><span class="p">.</span><span class="nx">dbpedia</span><span class="si">}</span><span class="s">Organisation&quot;</span>
                <span class="nv">label: </span><span class="s">&#39;Organisation&#39;</span>
            <span class="p">,</span>
                <span class="nv">uri: </span>  <span class="s">&quot;</span><span class="si">#{</span><span class="nx">@ns</span><span class="p">.</span><span class="nx">skos</span><span class="si">}</span><span class="s">Concept&quot;</span>
                <span class="nv">label: </span><span class="s">&#39;Concept&#39;</span>
            <span class="p">]</span></pre></div></td></tr><tr id="section-25"><td class="docs"><div class="pilwrap"><a href="#section-25" class="pilcrow">&#182;</a></div><p>Give a label to the sources the entities come from</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nv">getSources: </span><span class="o">-&gt;</span>
            <span class="p">[</span>
                <span class="nv">uri: </span><span class="s">&quot;http://dbpedia.org/resource/&quot;</span>
                <span class="nv">label: </span><span class="s">&quot;dbpedia&quot;</span>
            <span class="p">,</span>
                <span class="nv">uri: </span><span class="s">&quot;http://sws.geonames.org/&quot;</span>
                <span class="nv">label: </span><span class="s">&quot;geonames&quot;</span>
            <span class="p">]</span></pre></div></td></tr><tr id="section-26"><td class="docs"><div class="pilwrap"><a href="#section-26" class="pilcrow">&#182;</a></div><p>widget specific constructor</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nv">_create: </span><span class="o">-&gt;</span>
        <span class="nv">widget = </span><span class="nx">@</span></pre></div></td></tr><tr id="section-27"><td class="docs"><div class="pilwrap"><a href="#section-27" class="pilcrow">&#182;</a></div><p>logger can be turned on and off. It will show the real caller line in the log</p>
</td><td class="code"><div class="highlight"><pre>        <span class="vi">@_logger = </span><span class="k">if</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">debug</span> <span class="k">then</span> <span class="nx">console</span> <span class="k">else</span> 
            <span class="nv">info: </span><span class="o">-&gt;</span>
            <span class="nv">warn: </span><span class="o">-&gt;</span>
            <span class="nv">error: </span><span class="o">-&gt;</span>
            <span class="nv">log: </span><span class="o">-&gt;</span></pre></div></td></tr><tr id="section-28"><td class="docs"><div class="pilwrap"><a href="#section-28" class="pilcrow">&#182;</a></div><p>widget.entityCache.get(uri, cb) will get and cache the entity from an entityhub</p>
</td><td class="code"><div class="highlight"><pre>        <span class="vi">@entityCache = </span><span class="k">new</span> <span class="nx">EntityCache</span> 
            <span class="nv">vie: </span><span class="nx">@options</span><span class="p">.</span><span class="nx">vie</span>
            <span class="nv">logger: </span><span class="nx">@_logger</span>
        <span class="k">if</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">autoAnalyze</span>
            <span class="nx">@enable</span><span class="p">()</span>
        <span class="nx">unless</span> <span class="nx">jQuery</span><span class="p">().</span><span class="nx">tooltip</span>
            <span class="vi">@options.showTooltip = </span><span class="kc">false</span>
            <span class="nx">@_logger</span><span class="p">.</span><span class="nx">warn</span> <span class="s">&quot;the used jQuery UI doesn&#39;t support tooltips, disabling.&quot;</span>
        <span class="nx">@_initExistingAnnotations</span><span class="p">()</span>
    <span class="nv">_destroy: </span><span class="o">-&gt;</span>
        <span class="nx">do</span> <span class="nx">@disable</span>
        <span class="nx">$</span><span class="p">(</span> <span class="s">&#39;:iks-annotationselector&#39;</span><span class="p">,</span> <span class="nx">@element</span> <span class="p">).</span><span class="nx">each</span> <span class="nf">() -&gt;</span>
            <span class="nx">$</span><span class="p">(</span><span class="nx">@</span><span class="p">).</span><span class="nx">annotationSelector</span> <span class="s">&#39;destroy&#39;</span> <span class="k">if</span> <span class="nx">$</span><span class="p">(</span><span class="nx">@</span><span class="p">).</span><span class="nx">data</span><span class="p">().</span><span class="nx">annotationSelector</span>
        <span class="nx">@_destroyExistingAnnotationInteractionWidgets</span><span class="p">()</span></pre></div></td></tr><tr id="section-29"><td class="docs"><div class="pilwrap"><a href="#section-29" class="pilcrow">&#182;</a></div><p>analyze the widget element and show text enhancements</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nv">enable: </span><span class="o">-&gt;</span>
      <span class="k">if</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">continuousChecking</span>
        <span class="nv">checkerFn = </span><span class="nx">delayThrottle</span> <span class="o">=&gt;</span>
          <span class="nx">@_checkForChanges</span><span class="p">()</span>
        <span class="p">,</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">throttleDistance</span>

        <span class="nx">$</span><span class="p">(</span><span class="nx">@element</span><span class="p">).</span><span class="nx">bind</span> <span class="s">&#39;keyup&#39;</span><span class="p">,</span> <span class="o">=&gt;</span>
          <span class="nx">checkerFn</span><span class="p">()</span>
      <span class="nx">@_checkForChanges</span><span class="p">()</span>


    <span class="nv">_checkForChanges: </span><span class="o">-&gt;</span>
      <span class="k">for</span> <span class="nx">el</span> <span class="k">in</span> <span class="nx">@_findElementsToAnalyze</span><span class="p">()</span>
        <span class="nv">hash = </span><span class="nx">@_elementHash</span> <span class="nx">el</span>
        <span class="nx">unless</span> <span class="nx">jQuery</span><span class="p">(</span><span class="nx">el</span><span class="p">).</span><span class="nx">data</span><span class="p">(</span><span class="s">&#39;hash&#39;</span><span class="p">)</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">info</span> <span class="nx">el</span><span class="p">,</span> <span class="s">&quot;wasn&#39;t analized yet.&quot;</span>
          <span class="nx">@_analyze</span> <span class="nx">el</span>
        <span class="k">if</span> <span class="nx">jQuery</span><span class="p">(</span><span class="nx">el</span><span class="p">).</span><span class="nx">data</span><span class="p">(</span><span class="s">&#39;hash&#39;</span><span class="p">)</span> <span class="o">and</span> <span class="nx">jQuery</span><span class="p">(</span><span class="nx">el</span><span class="p">).</span><span class="nx">data</span><span class="p">(</span><span class="s">&#39;hash&#39;</span><span class="p">)</span> <span class="o">isnt</span> <span class="nx">hash</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">info</span> <span class="nx">el</span><span class="p">,</span> <span class="s">&#39;changed, try to get annotations for it.&#39;</span>
          <span class="nx">@_analyze</span> <span class="nx">el</span>

    <span class="nv">_elementHash: </span><span class="nf">(el) -&gt;</span>
      <span class="nx">jQuery</span><span class="p">(</span><span class="nx">el</span><span class="p">).</span><span class="nx">text</span><span class="p">().</span><span class="nx">hashCode</span><span class="p">()</span>

    <span class="nv">_findElementsToAnalyze: </span><span class="o">-&gt;</span>
      <span class="nx">@_listNonblockElements</span> <span class="nx">@element</span>

    <span class="nv">_analyze: </span><span class="nf">(el) -&gt;</span>
        <span class="nv">hash = </span><span class="nx">@_elementHash</span> <span class="nx">el</span></pre></div></td></tr><tr id="section-30"><td class="docs"><div class="pilwrap"><a href="#section-30" class="pilcrow">&#182;</a></div><p>the analyzedDocUri makes the connection between a document state and
the annotations to it. We have to clean up the annotations to any
old document state</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nx">@options</span><span class="p">.</span><span class="nx">vie</span><span class="p">.</span><span class="nx">analyze</span><span class="p">(</span> <span class="nv">element: </span><span class="nx">jQuery</span> <span class="nx">el</span> <span class="p">).</span><span class="nx">using</span><span class="p">(</span><span class="nx">@options</span><span class="p">.</span><span class="nx">vieServices</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">execute</span><span class="p">()</span>
        <span class="p">.</span><span class="nx">success</span> <span class="p">(</span><span class="nx">enhancements</span><span class="p">)</span> <span class="o">=&gt;</span>
          <span class="k">if</span> <span class="nx">@_elementHash</span><span class="p">(</span><span class="nx">el</span><span class="p">)</span> <span class="o">is</span> <span class="nx">hash</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">info</span> <span class="s">&#39;applying suggestions to&#39;</span><span class="p">,</span> <span class="nx">el</span><span class="p">,</span> <span class="nx">enhancements</span>
            <span class="nx">@_applyEnhancements</span> <span class="nx">el</span><span class="p">,</span> <span class="nx">enhancements</span>
            <span class="nx">jQuery</span><span class="p">(</span><span class="nx">el</span><span class="p">).</span><span class="nx">data</span> <span class="s">&#39;hash&#39;</span><span class="p">,</span> <span class="nx">hash</span>
          <span class="k">else</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">info</span> <span class="nx">el</span><span class="p">,</span> <span class="s">&#39;changed in the meantime.&#39;</span>
          <span class="nx">@_trigger</span> <span class="s">&quot;success&quot;</span><span class="p">,</span> <span class="kc">true</span>
        <span class="p">.</span><span class="nx">fail</span> <span class="p">(</span><span class="nx">xhr</span><span class="p">)</span> <span class="o">=&gt;</span>
          <span class="nx">@_trigger</span> <span class="s">&#39;error&#39;</span><span class="p">,</span> <span class="nx">xhr</span>
          <span class="nx">@_logger</span><span class="p">.</span><span class="nx">error</span> <span class="s">&quot;analyze failed&quot;</span><span class="p">,</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">responseText</span><span class="p">,</span> <span class="nx">xhr</span>

    <span class="nv">_applyEnhancements: </span><span class="nf">(el, enhancements) -&gt;</span>
        <span class="nx">_</span><span class="p">.</span><span class="nx">defer</span> <span class="o">=&gt;</span></pre></div></td></tr><tr id="section-31"><td class="docs"><div class="pilwrap"><a href="#section-31" class="pilcrow">&#182;</a></div><p>Link TextAnnotation entities to EntityAnnotations</p>
</td><td class="code"><div class="highlight"><pre>          <span class="nv">entityAnnotations = </span><span class="nx">Stanbol</span><span class="p">.</span><span class="nx">getEntityAnnotations</span><span class="p">(</span><span class="nx">enhancements</span><span class="p">)</span>
          <span class="k">for</span> <span class="nx">entAnn</span> <span class="k">in</span> <span class="nx">entityAnnotations</span>
              <span class="nv">textAnns = </span><span class="nx">entAnn</span><span class="p">.</span><span class="nx">get</span> <span class="s">&quot;dcterms:relation&quot;</span>
              <span class="nx">unless</span> <span class="nx">textAnns</span>
                  <span class="nx">@_logger</span><span class="p">.</span><span class="nx">error</span> <span class="s">&quot;For </span><span class="si">#{</span><span class="nx">entAnn</span><span class="p">.</span><span class="nx">getSubject</span><span class="p">()</span><span class="si">}</span><span class="s"> dcterms:relation is not set! This makes this EntityAnnotation unusable!&quot;</span><span class="p">,</span> <span class="nx">entAnn</span>
                  <span class="k">continue</span>
              <span class="k">for</span> <span class="nx">textAnn</span> <span class="k">in</span> <span class="nx">_</span><span class="p">.</span><span class="nx">flatten</span><span class="p">([</span><span class="nx">textAnns</span><span class="p">])</span>
                  <span class="nv">textAnn = </span><span class="nx">entAnn</span><span class="p">.</span><span class="nx">vie</span><span class="p">.</span><span class="nx">entities</span><span class="p">.</span><span class="nx">get</span> <span class="nx">textAnn</span> <span class="nx">unless</span> <span class="nx">textAnn</span> <span class="k">instanceof</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span>
                  <span class="k">continue</span> <span class="nx">unless</span> <span class="nx">textAnn</span>
                  <span class="nx">_</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">flatten</span><span class="p">([</span><span class="nx">textAnn</span><span class="p">])).</span><span class="nx">each</span> <span class="nf">(ta) -&gt;</span>
                      <span class="nx">ta</span><span class="p">.</span><span class="nx">setOrAdd</span>
                          <span class="s">&quot;entityAnnotation&quot;</span><span class="o">:</span> <span class="nx">entAnn</span><span class="p">.</span><span class="nx">getSubject</span><span class="p">()</span></pre></div></td></tr><tr id="section-32"><td class="docs"><div class="pilwrap"><a href="#section-32" class="pilcrow">&#182;</a></div><p>Get enhancements</p>
</td><td class="code"><div class="highlight"><pre>          <span class="nv">textAnnotations = </span><span class="nx">Stanbol</span><span class="p">.</span><span class="nx">getTextAnnotations</span><span class="p">(</span><span class="nx">enhancements</span><span class="p">)</span>
          <span class="nv">textAnnotations = </span><span class="nx">@_filterByType</span> <span class="nx">textAnnotations</span></pre></div></td></tr><tr id="section-33"><td class="docs"><div class="pilwrap"><a href="#section-33" class="pilcrow">&#182;</a></div><p>Remove all textAnnotations without a selected text property</p>
</td><td class="code"><div class="highlight"><pre>          <span class="nv">textAnnotations = </span><span class="nx">_</span><span class="p">(</span><span class="nx">textAnnotations</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">filter</span> <span class="nf">(textEnh) -&gt;</span>
              <span class="k">if</span> <span class="nx">textEnh</span><span class="p">.</span><span class="nx">getSelectedText</span> <span class="o">and</span> <span class="nx">textEnh</span><span class="p">.</span><span class="nx">getSelectedText</span><span class="p">()</span>
                  <span class="kc">true</span>
              <span class="k">else</span>
                  <span class="kc">false</span>
          <span class="nx">_</span><span class="p">(</span><span class="nx">textAnnotations</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">each</span> <span class="p">(</span><span class="nx">s</span><span class="p">)</span> <span class="o">=&gt;</span>
              <span class="nx">@_logger</span><span class="p">.</span><span class="nx">info</span> <span class="nx">s</span><span class="p">.</span><span class="nx">_enhancement</span><span class="p">,</span>
                  <span class="s">&#39;confidence&#39;</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">getConfidence</span><span class="p">(),</span>
                  <span class="s">&#39;selectedText&#39;</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">getSelectedText</span><span class="p">(),</span>
                  <span class="s">&#39;type&#39;</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">getType</span><span class="p">(),</span>
                  <span class="s">&#39;EntityEnhancements&#39;</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">getEntityEnhancements</span><span class="p">()</span></pre></div></td></tr><tr id="section-34"><td class="docs"><div class="pilwrap"><a href="#section-34" class="pilcrow">&#182;</a></div><p>Process the text enhancements</p>
</td><td class="code"><div class="highlight"><pre>              <span class="nx">@_processTextEnhancement</span> <span class="nx">s</span><span class="p">,</span> <span class="nx">el</span></pre></div></td></tr><tr id="section-35"><td class="docs"><div class="pilwrap"><a href="#section-35" class="pilcrow">&#182;</a></div><p>Remove all not accepted text enhancement widgets</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nv">disable: </span><span class="o">-&gt;</span>
        <span class="nx">$</span><span class="p">(</span> <span class="s">&#39;:IKS-annotationSelector&#39;</span><span class="p">,</span> <span class="nx">@element</span> <span class="p">).</span><span class="nx">each</span> <span class="nf">() -&gt;</span>
            <span class="nx">$</span><span class="p">(</span><span class="nx">@</span><span class="p">).</span><span class="nx">annotationSelector</span> <span class="s">&#39;disable&#39;</span> <span class="k">if</span> <span class="nx">$</span><span class="p">(</span><span class="nx">@</span><span class="p">).</span><span class="nx">data</span><span class="p">().</span><span class="nx">annotationSelector</span>
    <span class="nv">_initExistingAnnotations: </span><span class="o">-&gt;</span>
        <span class="vi">@existingAnnotations = </span><span class="nx">jQuery</span> <span class="s">&quot;a[resource]&quot;</span><span class="p">,</span> <span class="nx">@element</span>
        <span class="nx">@_logger</span><span class="p">.</span><span class="nx">info</span> <span class="nx">@existingAnnotations</span>
        <span class="nx">@existingAnnotations</span><span class="p">[</span><span class="nx">@options</span><span class="p">.</span><span class="nx">annotationInteractionWidget</span><span class="p">]</span> <span class="nx">@options</span>
    <span class="nv">_destroyExistingAnnotationInteractionWidgets: </span><span class="o">-&gt;</span>
        <span class="nx">@existingAnnotations</span><span class="p">[</span><span class="nx">@options</span><span class="p">.</span><span class="nx">annotationInteractionWidget</span><span class="p">]</span> <span class="s">&quot;destroy&quot;</span>
        <span class="vi">@existingAnnotations = </span><span class="p">[]</span></pre></div></td></tr><tr id="section-36"><td class="docs"><div class="pilwrap"><a href="#section-36" class="pilcrow">&#182;</a></div><p>accept the best (first) suggestion for all text enhancement.</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nv">acceptAll: </span><span class="nf">(reportCallback) -&gt;</span>
        <span class="nv">report = </span><span class="p">{</span><span class="nv">updated: </span><span class="p">[],</span> <span class="nv">accepted: </span><span class="mi">0</span><span class="p">}</span>
        <span class="nx">$</span><span class="p">(</span> <span class="s">&#39;:IKS-annotationSelector&#39;</span><span class="p">,</span> <span class="nx">@element</span> <span class="p">).</span><span class="nx">each</span> <span class="nf">() -&gt;</span>
            <span class="k">if</span> <span class="nx">$</span><span class="p">(</span><span class="nx">@</span><span class="p">).</span><span class="nx">data</span><span class="p">().</span><span class="nx">annotationSelector</span>
                <span class="nv">res = </span><span class="nx">$</span><span class="p">(</span><span class="nx">@</span><span class="p">).</span><span class="nx">annotationSelector</span> <span class="s">&#39;acceptBestCandidate&#39;</span>
                <span class="k">if</span> <span class="nx">res</span>
                    <span class="nx">report</span><span class="p">.</span><span class="nx">updated</span><span class="p">.</span><span class="nx">push</span> <span class="nx">@</span>
                    <span class="nx">report</span><span class="p">.</span><span class="nx">accepted</span><span class="o">++</span>
        <span class="nx">reportCallback</span> <span class="nx">report</span></pre></div></td></tr><tr id="section-37"><td class="docs"><div class="pilwrap"><a href="#section-37" class="pilcrow">&#182;</a></div><p>Internal methods
Devide an element into smaller chunks that can be analyzed in smaller portions.</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nv">_listNonblockElements: </span><span class="nf">(el) -&gt;</span></pre></div></td></tr><tr id="section-38"><td class="docs"><div class="pilwrap"><a href="#section-38" class="pilcrow">&#182;</a></div><p>An element is devidable if the sum of all it's children's text is it's own text. Otherwise it has textnodes that are no dom tags.</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nv">isDevidable = </span><span class="p">(</span><span class="nx">el</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nv">sum = </span><span class="s">&quot;&quot;</span>
        <span class="k">for</span> <span class="nx">child</span> <span class="k">in</span> <span class="nx">jQuery</span><span class="p">(</span><span class="nx">el</span><span class="p">).</span><span class="nx">children</span><span class="p">()</span>
          <span class="nx">sum</span> <span class="o">+=</span> <span class="nx">jQuery</span><span class="p">(</span><span class="nx">child</span><span class="p">).</span><span class="nx">text</span><span class="p">().</span><span class="nx">replace</span> <span class="sr">/\s\s*/g</span><span class="p">,</span> <span class="s">&quot;&quot;</span>
        <span class="nx">jQuery</span><span class="p">(</span><span class="nx">el</span><span class="p">).</span><span class="nx">text</span><span class="p">().</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\s\s*/g</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">)</span> <span class="o">is</span> <span class="nx">sum</span>

      <span class="nv">res = </span><span class="nx">jQuery</span> <span class="p">[]</span>
      <span class="k">if</span> <span class="nx">isDevidable</span> <span class="nx">el</span>
        <span class="nx">jQuery</span><span class="p">(</span><span class="nx">el</span><span class="p">).</span><span class="nx">children</span><span class="p">().</span><span class="nx">each</span> <span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">ch</span><span class="p">)</span> <span class="o">=&gt;</span>
          <span class="nv">res = </span><span class="nx">res</span><span class="p">.</span><span class="nx">add</span> <span class="nx">@_listNonblockElements</span><span class="p">(</span><span class="nx">ch</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="nv">res = </span><span class="nx">res</span><span class="p">.</span><span class="nx">add</span> <span class="nx">jQuery</span> <span class="nx">el</span>
      <span class="nx">res</span></pre></div></td></tr><tr id="section-39"><td class="docs"><div class="pilwrap"><a href="#section-39" class="pilcrow">&#182;</a></div><p>processTextEnhancement deals with one TextEnhancement in an ancestor element of its occurrence</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nv">_processTextEnhancement: </span><span class="nf">(textEnh, parentEl) -&gt;</span>
        <span class="k">if</span> <span class="o">not</span> <span class="nx">textEnh</span><span class="p">.</span><span class="nx">getSelectedText</span><span class="p">()</span>
            <span class="nx">@_logger</span><span class="p">.</span><span class="nx">warn</span> <span class="s">&quot;textEnh&quot;</span><span class="p">,</span> <span class="nx">textEnh</span><span class="p">,</span> <span class="s">&quot;doesn&#39;t have selected-text!&quot;</span>
            <span class="k">return</span>
        <span class="nv">el = </span><span class="nx">$</span> <span class="nx">@_getOrCreateDomElement</span> <span class="nx">parentEl</span><span class="p">,</span> <span class="nx">textEnh</span><span class="p">.</span><span class="nx">getSelectedText</span><span class="p">(),</span>
            <span class="nv">createElement: </span><span class="s">&#39;span&#39;</span>
            <span class="nv">createMode: </span><span class="s">&#39;existing&#39;</span>
            <span class="nv">context: </span><span class="nx">textEnh</span><span class="p">.</span><span class="nx">getContext</span><span class="p">()</span>
            <span class="nv">start: </span>  <span class="nx">textEnh</span><span class="p">.</span><span class="nx">getStart</span><span class="p">()</span>
            <span class="nv">end: </span>    <span class="nx">textEnh</span><span class="p">.</span><span class="nx">getEnd</span><span class="p">()</span>
        <span class="nv">sType = </span><span class="nx">textEnh</span><span class="p">.</span><span class="nx">getType</span><span class="p">()</span> <span class="o">or</span> <span class="s">&quot;Other&quot;</span>
        <span class="nv">widget = </span><span class="nx">@</span>
        <span class="nx">el</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="s">&#39;entity&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="nx">type</span> <span class="k">in</span> <span class="nx">sType</span>
            <span class="nx">el</span><span class="p">.</span><span class="nx">addClass</span> <span class="nx">uriSuffix</span><span class="p">(</span><span class="nx">type</span><span class="p">).</span><span class="nx">toLowerCase</span><span class="p">()</span>
        <span class="k">if</span> <span class="nx">textEnh</span><span class="p">.</span><span class="nx">getEntityEnhancements</span><span class="p">().</span><span class="nx">length</span>
            <span class="nx">el</span><span class="p">.</span><span class="nx">addClass</span> <span class="s">&quot;withSuggestions&quot;</span>
        <span class="k">for</span> <span class="nx">eEnh</span> <span class="k">in</span> <span class="nx">textEnh</span><span class="p">.</span><span class="nx">getEntityEnhancements</span><span class="p">()</span>
            <span class="nv">eEnhUri = </span><span class="nx">eEnh</span><span class="p">.</span><span class="nx">getUri</span><span class="p">()</span>
            <span class="nx">@entityCache</span><span class="p">.</span><span class="nx">get</span> <span class="nx">eEnhUri</span><span class="p">,</span> <span class="nx">eEnh</span><span class="p">,</span> <span class="p">(</span><span class="nx">entity</span><span class="p">)</span> <span class="o">=&gt;</span>
                <span class="k">if</span> <span class="s">&quot;&lt;</span><span class="si">#{</span><span class="nx">eEnhUri</span><span class="si">}</span><span class="s">&gt;&quot;</span> <span class="o">is</span> <span class="nx">entity</span><span class="p">.</span><span class="nx">getSubject</span><span class="p">()</span>
                    <span class="nx">@_logger</span><span class="p">.</span><span class="nx">info</span> <span class="s">&quot;entity </span><span class="si">#{</span><span class="nx">eEnhUri</span><span class="si">}</span><span class="s"> is loaded:&quot;</span><span class="p">,</span>
                        <span class="nx">entity</span><span class="p">.</span><span class="nx">as</span> <span class="s">&quot;JSON&quot;</span>
                <span class="k">else</span>
                    <span class="nx">widget</span><span class="p">.</span><span class="nx">_logger</span><span class="p">.</span><span class="nx">info</span> <span class="s">&quot;forwarded entity for </span><span class="si">#{</span><span class="nx">eEnhUri</span><span class="si">}</span><span class="s"> loaded:&quot;</span><span class="p">,</span> <span class="nx">entity</span><span class="p">.</span><span class="nx">getSubject</span><span class="p">()</span></pre></div></td></tr><tr id="section-40"><td class="docs"><div class="pilwrap"><a href="#section-40" class="pilcrow">&#182;</a></div><p>Create widget to select from the suggested entities</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nv">options = </span><span class="nx">@options</span>
        <span class="nv">options.cache = </span><span class="nx">@entityCache</span>
        <span class="nv">options.annotateElement = </span><span class="nx">@element</span>
        <span class="nx">el</span><span class="p">.</span><span class="nx">annotationSelector</span><span class="p">(</span> <span class="nx">options</span> <span class="p">)</span>
        <span class="p">.</span><span class="nx">annotationSelector</span> <span class="s">&#39;addTextEnhancement&#39;</span><span class="p">,</span> <span class="nx">textEnh</span>

    <span class="nv">_filterByType: </span><span class="nf">(textAnnotations) -&gt;</span>
        <span class="k">return</span> <span class="nx">textAnnotations</span> <span class="nx">unless</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">typeFilter</span>
        <span class="nx">_</span><span class="p">.</span><span class="nx">filter</span> <span class="nx">textAnnotations</span><span class="p">,</span> <span class="p">(</span><span class="nx">ta</span><span class="p">)</span> <span class="o">=&gt;</span>
            <span class="k">return</span> <span class="kc">yes</span> <span class="k">if</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">typeFilter</span> <span class="k">in</span> <span class="nx">ta</span><span class="p">.</span><span class="nx">getType</span><span class="p">()</span>
            <span class="k">for</span> <span class="nx">type</span> <span class="k">in</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">typeFilter</span>
                <span class="k">return</span> <span class="kc">yes</span> <span class="k">if</span> <span class="nx">type</span> <span class="k">in</span> <span class="nx">ta</span><span class="p">.</span><span class="nx">getType</span><span class="p">()</span></pre></div></td></tr><tr id="section-41"><td class="docs"><div class="pilwrap"><a href="#section-41" class="pilcrow">&#182;</a></div><p>get or create a dom element containing only the occurrence of the found entity</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nv">_getOrCreateDomElement: </span><span class="nf">(element, text, options = {}) -&gt;</span></pre></div></td></tr><tr id="section-42"><td class="docs"><div class="pilwrap"><a href="#section-42" class="pilcrow">&#182;</a></div><p>Find occurrence indexes of s in str</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nv">occurrences = </span><span class="nf">(str, s) -&gt;</span>
            <span class="nv">res = </span><span class="p">[]</span>
            <span class="nv">last = </span><span class="mi">0</span>
            <span class="k">while</span> <span class="nx">str</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="nx">last</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">isnt</span> <span class="o">-</span><span class="mi">1</span>
                <span class="nv">next = </span><span class="nx">str</span><span class="p">.</span><span class="nx">indexOf</span> <span class="nx">s</span><span class="p">,</span> <span class="nx">last</span><span class="o">+</span><span class="mi">1</span>
                <span class="nx">res</span><span class="p">.</span><span class="nx">push</span> <span class="nx">next</span>
                <span class="nv">last = </span><span class="nx">next</span></pre></div></td></tr><tr id="section-43"><td class="docs"><div class="pilwrap"><a href="#section-43" class="pilcrow">&#182;</a></div><p>Find the nearest number among the </p>
</td><td class="code"><div class="highlight"><pre>        <span class="nv">nearest = </span><span class="nf">(arr, nr) -&gt;</span>
            <span class="nx">_</span><span class="p">(</span><span class="nx">arr</span><span class="p">).</span><span class="nx">sortedIndex</span> <span class="nx">nr</span></pre></div></td></tr><tr id="section-44"><td class="docs"><div class="pilwrap"><a href="#section-44" class="pilcrow">&#182;</a></div><p>Nearest position</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nv">nearestPosition = </span><span class="nf">(str, s, ind) -&gt;</span>
            <span class="nv">arr = </span><span class="nx">occurrences</span><span class="p">(</span><span class="nx">str</span><span class="p">,</span><span class="nx">s</span><span class="p">)</span>
            <span class="nv">i1 = </span><span class="nx">nearest</span> <span class="nx">arr</span><span class="p">,</span> <span class="nx">ind</span>
            <span class="k">if</span> <span class="nx">arr</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">1</span>
                <span class="nx">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span> <span class="k">if</span> <span class="nx">i1</span> <span class="o">is</span> <span class="nx">arr</span><span class="p">.</span><span class="nx">length</span>
                <span class="nx">arr</span><span class="p">[</span><span class="nx">i1</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span>
                <span class="nv">i0 = </span><span class="nx">i1</span><span class="o">-</span><span class="mi">1</span>
                <span class="nv">d0 = </span><span class="nx">ind</span> <span class="o">-</span> <span class="nx">arr</span><span class="p">[</span><span class="nx">i0</span><span class="p">]</span>
                <span class="nv">d1 = </span><span class="nx">arr</span><span class="p">[</span><span class="nx">i1</span><span class="p">]</span> <span class="o">-</span> <span class="nx">ind</span>
                <span class="k">if</span> <span class="nx">d1</span> <span class="o">&gt;</span> <span class="nx">d0</span> <span class="k">then</span> <span class="nx">arr</span><span class="p">[</span><span class="nx">i0</span><span class="p">]</span>
                <span class="k">else</span> <span class="nx">arr</span><span class="p">[</span><span class="nx">i1</span><span class="p">]</span>

        <span class="nv">domEl = </span><span class="nx">element</span>
        <span class="nv">textContentOf = </span><span class="nf">(element) -&gt;</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">).</span><span class="nx">text</span><span class="p">().</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\n/g</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">)</span></pre></div></td></tr><tr id="section-45"><td class="docs"><div class="pilwrap"><a href="#section-45" class="pilcrow">&#182;</a></div><p>find the text node</p>
</td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="nx">textContentOf</span><span class="p">(</span><span class="nx">element</span><span class="p">).</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="o">is</span> <span class="o">-</span><span class="mi">1</span>
            <span class="nx">@_logger</span><span class="p">.</span><span class="nx">error</span> <span class="s">&quot;&#39;</span><span class="si">#{</span><span class="nx">text</span><span class="si">}</span><span class="s">&#39; doesn&#39;t appear in the text block.&quot;</span>
            <span class="k">return</span> <span class="nx">$</span><span class="p">()</span>
        <span class="nv">start = </span><span class="nx">options</span><span class="p">.</span><span class="nx">start</span> <span class="o">+</span>
        <span class="nx">textContentOf</span><span class="p">(</span><span class="nx">element</span><span class="p">).</span><span class="nx">indexOf</span> <span class="nx">textContentOf</span><span class="p">(</span><span class="nx">element</span><span class="p">).</span><span class="nx">trim</span><span class="p">()</span></pre></div></td></tr><tr id="section-46"><td class="docs"><div class="pilwrap"><a href="#section-46" class="pilcrow">&#182;</a></div><p>Correct small position errors</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nv">start = </span><span class="nx">nearestPosition</span> <span class="nx">textContentOf</span><span class="p">(</span><span class="nx">element</span><span class="p">),</span> <span class="nx">text</span><span class="p">,</span> <span class="nx">start</span>
        <span class="nv">pos = </span><span class="mi">0</span>
        <span class="k">while</span> <span class="nx">textContentOf</span><span class="p">(</span><span class="nx">domEl</span><span class="p">).</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="o">isnt</span> <span class="o">-</span><span class="mi">1</span> <span class="o">and</span> <span class="nx">domEl</span><span class="p">.</span><span class="nx">nodeName</span> <span class="o">isnt</span> <span class="s">&#39;#text&#39;</span>
            <span class="nv">domEl = </span><span class="nx">_</span><span class="p">(</span><span class="nx">domEl</span><span class="p">.</span><span class="nx">childNodes</span><span class="p">).</span><span class="nx">detect</span> <span class="nf">(el) -&gt;</span>
                <span class="nv">p = </span><span class="nx">textContentOf</span><span class="p">(</span><span class="nx">el</span><span class="p">).</span><span class="nx">lastIndexOf</span> <span class="nx">text</span>
                <span class="k">if</span> <span class="nx">p</span> <span class="o">&gt;=</span> <span class="nx">start</span> <span class="o">-</span> <span class="nx">pos</span>
                    <span class="kc">true</span>
                <span class="k">else</span>
                    <span class="nx">pos</span> <span class="o">+=</span> <span class="nx">textContentOf</span><span class="p">(</span><span class="nx">el</span><span class="p">).</span><span class="nx">length</span>
                    <span class="kc">false</span>

        <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">createMode</span> <span class="o">is</span> <span class="s">&quot;existing&quot;</span> <span class="o">and</span> <span class="nx">textContentOf</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="nx">domEl</span><span class="p">).</span><span class="nx">parent</span><span class="p">())</span> <span class="o">is</span> <span class="nx">text</span>
            <span class="k">return</span> <span class="nx">$</span><span class="p">(</span><span class="nx">domEl</span><span class="p">).</span><span class="nx">parent</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span>
            <span class="nv">pos = </span><span class="nx">start</span> <span class="o">-</span> <span class="nx">pos</span>
            <span class="nv">len = </span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span>
            <span class="nv">textToCut = </span><span class="nx">textContentOf</span><span class="p">(</span><span class="nx">domEl</span><span class="p">).</span><span class="nx">substring</span><span class="p">(</span><span class="nx">pos</span><span class="p">,</span> <span class="nx">pos</span><span class="o">+</span><span class="nx">len</span><span class="p">)</span>
            <span class="k">if</span> <span class="nx">textToCut</span> <span class="o">is</span> <span class="nx">text</span>
                <span class="nx">domEl</span><span class="p">.</span><span class="nx">splitText</span> <span class="nx">pos</span> <span class="o">+</span> <span class="nx">len</span>
                <span class="nv">newElement = </span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span> <span class="nx">options</span><span class="p">.</span><span class="nx">createElement</span> <span class="o">or</span> <span class="s">&#39;span&#39;</span>
                <span class="nv">newElement.innerHTML = </span><span class="nx">text</span>
                <span class="nx">$</span><span class="p">(</span><span class="nx">domEl</span><span class="p">).</span><span class="nx">parent</span><span class="p">()[</span><span class="mi">0</span><span class="p">].</span><span class="nx">replaceChild</span> <span class="nx">newElement</span><span class="p">,</span> <span class="nx">domEl</span><span class="p">.</span><span class="nx">splitText</span> <span class="nx">pos</span>
                <span class="nx">$</span> <span class="nx">newElement</span>
            <span class="k">else</span>
                <span class="nx">@_logger</span><span class="p">.</span><span class="nx">warn</span> <span class="s">&quot;dom element creation problem: </span><span class="si">#{</span><span class="nx">textToCut</span><span class="si">}</span><span class="s"> isnt </span><span class="si">#{</span><span class="nx">text</span><span class="si">}</span><span class="s">&quot;</span></pre></div></td></tr><tr id="section-47"><td class="docs"><div class="pilwrap"><a href="#section-47" class="pilcrow">&#182;</a></div><p>Similar to the Java String.hashCode() method, it calculates a hash value of the string.</p>
</td><td class="code"><div class="highlight"><pre><span class="nb">String</span><span class="o">::</span><span class="nv">hashCode = </span><span class="o">-&gt;</span>
  <span class="nv">hash = </span><span class="mi">0</span>
  <span class="k">return</span> <span class="nx">hash</span>  <span class="k">if</span> <span class="nx">@length</span> <span class="o">is</span> <span class="mi">0</span>
  <span class="nv">i = </span><span class="mi">0</span>
  <span class="k">while</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">@length</span>
    <span class="nv">char = </span><span class="nx">@charCodeAt</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span>
    <span class="nv">hash = </span><span class="p">((</span><span class="nx">hash</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">-</span> <span class="nx">hash</span><span class="p">)</span> <span class="o">+</span> <span class="nx">char</span>
    <span class="nv">hash = </span><span class="nx">hash</span> <span class="o">&amp;</span> <span class="nx">hash</span>
    <span class="nx">i</span><span class="o">++</span>
  <span class="nx">hash</span></pre></div></td></tr><tr id="section-48"><td class="docs"><div class="pilwrap"><a href="#section-48" class="pilcrow">&#182;</a></div><p>For throttling keyup events, this method sets up an event handler function resFn that only triggers the callback function cb after
being called the resFn at least once AND not being called for timout milliseconds.</p>
</td><td class="code"><div class="highlight"><pre><span class="nv">delayThrottle = </span><span class="nf">(cb, timeout) -&gt;</span>
  <span class="nv">timeoutHandler = </span><span class="kc">null</span>
  <span class="nv">resFn = </span><span class="o">-&gt;</span>
    <span class="k">if</span> <span class="nx">timeoutHandler</span>
      <span class="nx">clearTimeout</span><span class="p">(</span><span class="nx">timeoutHandler</span><span class="p">)</span>
    <span class="nv">timeoutHandler = </span><span class="nx">setTimeout</span> <span class="o">-&gt;</span>
      <span class="nv">timeoutHandler = </span><span class="kc">null</span>
      <span class="nx">cb</span><span class="p">()</span>
    <span class="p">,</span> <span class="nx">timeout</span>

</pre></div></td></tr></tbody></table><div id="generated">generated Mon Dec 17 2012 17:33:24 GMT+0100 (CET)  </div></div></body></html>