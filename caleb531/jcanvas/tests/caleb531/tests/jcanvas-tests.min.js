(function(e){function i(){r.layer+=1}function s(){r.canvas+=1}function o(){r.global+=1}function u(t){var r={};r[t]=i;r[t]=s;n.setEventHooks(r);e.jCanvas.eventHooks[t]=o}function a(e){strictEqual(r.layer,e,"Triggers layer event callbacks");strictEqual(r.canvas,e,"Triggers canvas event hooks");strictEqual(r.global,e,"Triggers global event hooks")}function f(){n=e("<canvas width='500', height='500'></canvas>")}function l(){r={layer:0,canvas:0,global:0};e.jCanvas.clearCache();e.jCanvas.eventHooks={};e.jCanvas()}var t=e("#qunit-fixture"),n,r;l();module("Core API",{setup:f,teardown:l});test("$.support.canvas",function(){strictEqual(e.support.canvas,!0,"Detects canvas support")});test("saveCanvas()",function(){var t;n.saveCanvas();t=e.data(n[0],"jCanvas");strictEqual(t.savedTransforms.length,1,"Pushes transformation state to stack")});test("restoreCanvas()",function(){var t;n.saveCanvas();t=e.data(n[0],"jCanvas");n.restoreCanvas();strictEqual(t.savedTransforms.length,0,"Pops transformation state from stack")});test("rotateCanvas()",function(){var t;n.rotateCanvas({rotate:180});t=e.data(n[0],"jCanvas");strictEqual(t.savedTransforms.length,1,"Pushes transformation state to stack");strictEqual(t.transforms.rotate,Math.PI,"Updates rotate property")});test("scaleCanvas()",function(){var t;n.scaleCanvas({scale:2});t=e.data(n[0],"jCanvas");strictEqual(t.savedTransforms.length,1,"Pushes transformation state to stack");strictEqual(t.transforms.scaleX,2,"Updates scaleX property");strictEqual(t.transforms.scaleY,2,"Updates scaleY property")});test("translateCanvas()",function(){var t;n.translateCanvas({translate:2});t=e.data(n[0],"jCanvas");strictEqual(t.savedTransforms.length,1,"Pushes transformation state to stack");strictEqual(t.transforms.translateX,2,"Updates translateX property");strictEqual(t.transforms.translateY,2,"Updates translateY property")});module("Layer API",{setup:f,teardown:l});test("getLayers()",function(){var r;deepEqual(e().getLayers(),[],"Returns array for empty collection");deepEqual(t.getLayers(),[],"Returns array for non-canvas");r=n.getLayers();deepEqual(r,[],"Returns empty array for initial canvas");strictEqual(n.getLayers(),r,"Returns a reference to the layers array")});test("getLayer()",function(){var r;strictEqual(e().getLayer("square"),undefined,"Returns undefined for empty collection");strictEqual(t.getLayer("square"),undefined,"Returns undefined for non-canvas");strictEqual(n.getLayer("square"),undefined,"Returns undefined for non-existent layer");n.addLayer({type:"rectangle",name:"square"});n.addLayer({type:"arc",name:"circle"});r=n.getLayer(0);strictEqual(e.type(r),"object","Layer can be retrieved by positive index");strictEqual(n.getLayer(-2),r,"Layer can be retrieved by negative index");strictEqual(n.getLayer("square"),r,"Layer can be retrieved by name");strictEqual(n.getLayer(/^square$/gi),r,"Layer can be retrieved by regex");strictEqual(n.getLayer(r),r,"Layer can be retrieved by object")});test("getLayerGroup()",function(){var r;strictEqual(e().getLayerGroup("squares"),undefined,"Returns undefined for empty collection");strictEqual(t.getLayerGroup("squares"),undefined,"Returns undefined for non-canvas");strictEqual(n.getLayerGroup("squares"),undefined,"Returns undefined for non-existent group");n.addLayer({type:"rectangle",name:"square",groups:["squares"]});n.addLayer({type:"arc",name:"circle",groups:["ovals"]});r=n.getLayerGroup("squares");strictEqual(e.type(r),"array","Group can be retrieved by index");strictEqual(n.getLayerGroup(/^squares$/gi),r,"Group can be retrieved by regex");strictEqual(n.getLayerGroup(r),r,"Group can be retrieved by object");strictEqual(r.length,1,"Group contains the proper number of layers");strictEqual(r[0],n.getLayer("square"),"Group contains the proper layer")});test("getLayerIndex()",function(){strictEqual(e().getLayerIndex("foo"),-1,"Returns -1 for empty collection");strictEqual(t.getLayerIndex("foo"),-1,"Returns -1 for non-canvases");strictEqual(n.getLayerIndex("foo"),-1,"Returns -1 for non-existent layer");n.addLayer({type:"rectangle",name:"square"});n.addLayer({type:"arc",name:"circle"});strictEqual(n.getLayerIndex("square"),0,"Returns index of first layer");strictEqual(n.getLayerIndex("circle"),1,"Returns index of second layer")});test("setLayer()",function(){var e,t,r;u("change");n.addLayer({type:"rectangle",name:"square",fillStyle:"black",width:100,height:100,change:i});n.addLayer({type:"arc",name:"circle",change:i});e=n.getLayer("square");t=["boxes"];r={};n.setLayer(e,{fillStyle:"green",opacity:.5,name:"box",groups:t,data:r,width:"+=10",height:"-=10"});strictEqual(e.fillStyle,"green","Sets fillStyle of layer");strictEqual(e.opacity,.5,"Sets opacity of layer");strictEqual(n.getLayer("box"),e,"Sets name of layer");notStrictEqual(e.groups,t,"Clones arrays in property map");notStrictEqual(e.data,r,"Clones objects in property map");strictEqual(e.width,110,"Increments width by 10");strictEqual(e.height,90,"Decrements width by 10");a(1)});test("setLayers()",function(){var e,t;u("change");n.addLayer({type:"rectangle",name:"square",fillStyle:"black",change:i});n.addLayer({type:"arc",name:"circle",fillStyle:"red",change:i});e=n.getLayer("square");t=n.getLayer("circle");n.setLayers({fillStyle:"green"});strictEqual(e.fillStyle,"green","Sets fillStyle of first layer");strictEqual(t.fillStyle,"green","Sets fillStyle of second layer");a(2)});test("setLayerGroup()",function(){var e,t,r;u("change");n.addLayer({type:"rectangle",name:"square",change:i});n.addLayer({type:"arc",name:"circle",groups:["ovals"],change:i});n.addLayer({type:"ellipse",name:"oval",groups:["ovals"],change:i});e=n.getLayer("square");t=n.getLayer("circle");r=n.getLayer("oval");n.setLayerGroup("ovals",{fillStyle:"green"});strictEqual(t.fillStyle,"green","Sets properties of first layer in group");strictEqual(r.fillStyle,"green","Sets properties of second layer in group");notStrictEqual(e.fillStyle,"green","Does not set properties of layer outside of group");a(2)});test("moveLayer()",function(){u("move");n.addLayer({type:"rectangle",name:"square",move:i});n.addLayer({type:"arc",name:"circle"});n.addLayer({type:"ellipse",name:"oval"});n.jCanvas();n.moveLayer("square",1);strictEqual(n.getLayerIndex("square"),1,"Layer can be moved to positive index");n.moveLayer("square",-1);strictEqual(n.getLayerIndex("square"),1,"Layer can be moved to negative index");a(2)});test("removeLayer()",function(){u("remove");n.addLayer({type:"rectangle",name:"square",remove:i});n.addLayer({type:"arc",name:"circle"});n.removeLayer("square");strictEqual(n.getLayers().length,1,undefined,"Removes layer from layers array");strictEqual(n.getLayer("square"),undefined,"Layer is no longer retrievable");a(1)});test("removeLayers()",function(){u("remove");n.addLayer({type:"rectangle",name:"square",remove:i});n.addLayer({type:"arc",name:"circle",remove:i});n.removeLayers();strictEqual(n.getLayers().length,0,"Removes all layers from layers array");strictEqual(n.getLayer("square"),undefined,"First layer is no longer retrievable");strictEqual(n.getLayer("circle"),undefined,"Second layer is no longer retrievable");a(2)});test("removeLayerGroup()",function(){u("remove");n.addLayer({type:"rectangle",name:"square"});n.addLayer({type:"arc",name:"circle",groups:["ovals"],remove:i});n.addLayer({type:"ellipse",name:"oval",groups:["ovals"],remove:i});n.removeLayerGroup("ovals");strictEqual(n.getLayers().length,1,"Removes layer group from layers array");strictEqual(n.getLayerGroup("ovals"),undefined,"Layer group is no longer retrievable");a(2)});test("addLayerToGroup()",function(){var e,t,r;n.addLayer({type:"rectangle",name:"square",groups:["quadrilaterals"]});n.addLayer({type:"arc",name:"circle"});n.addLayer({type:"ellipse",name:"oval",groups:[]});n.addLayerToGroup("square","squares");n.addLayerToGroup("circle","ovals");n.addLayerToGroup("oval","ovals");t=n.getLayerGroup("squares");r=n.getLayerGroup("ovals");strictEqual(t.length,1,"Adds layer to group if layer is associated with at least one group");strictEqual(r.length,2,"Adds layer to group if layer is not associated with any groups");n.removeLayers();e=["ovals"];n.addLayer({type:"arc",name:"circle",groups:e});n.addLayer({type:"ellipse",name:"oval",groups:e});n.addLayerToGroup("oval","ellipses");strictEqual(n.getLayerGroup("ellipses").length,1,"Groups array is cloned upon layer creation")});test("removeLayerFromGroup()",function(){var e,t;n.addLayer({type:"rectangle",name:"square",groups:["shapes","squares"]});n.removeLayerFromGroup("square","squares");e=n.getLayerGroup("shapes");t=n.getLayerGroup("squares");strictEqual(t,undefined,"Removes layer from group");strictEqual(e.length,1,"Layer remains in other groups")});module("Event API",{setup:f,teardown:l});test("getEventHooks()",function(){deepEqual(e().getEventHooks(),{},"Returns object for empty collecion");deepEqual(t.getEventHooks(),{},"Returns object for non-canvas");deepEqual(n.getEventHooks(),{},"Returns object for canvas")});test("setEventHooks()",function(){n.setEventHooks({add:e.noop});strictEqual(n.getEventHooks().add,e.noop,"Sets event hooks for canvas")});test("triggerLayerEvent()",function(){u("mousedown");n.addLayer({type:"rectangle",name:"square",mousedown:i});n.triggerLayerEvent("square","mousedown");a(1)});module("Animation API",{setup:f,teardown:l});asyncTest("animateLayer()",function(){expect(9);n.addLayer({type:"path",opacity:1,fillStyle:"rgba(0, 0, 0)",strokeStyle:"#000",shadowColor:"rgba(0, 0, 0, 1)",strokeWidth:2,p1:{type:"line",x1:0,y1:0,x2:100,y2:100}});n.animateLayer(0,{fillStyle:"#f00",strokeStyle:"rgb(255, 0, 0)",shadowColor:"rgba(255, 0, 0, 0.5)",strokeWidth:10,p1:{x1:50}},10,function(e){var t;strictEqual(e.fillStyle,"rgb(255,0,0)","Animates hexadecimal color");strictEqual(e.strokeStyle,"rgb(255,0,0)","Animates RGB color");strictEqual(e.shadowColor,"rgba(255,0,0,0.5)","Animates RGBA color");strictEqual(e.strokeWidth,10,"Animates strokeWidth property");strictEqual(e.p1.x1,50,"Sub-property is animated");strictEqual(e["p1.x1"],undefined,"Sub-property alias is deleted");t=!1;n.animateLayer(0,{opacity:.5},{duration:10,step:function(n,r){if(!t){ok(n>=e.opacity,"Layer opacity is animating from 1 to 0.5");strictEqual(r.prop,"opacity","Hidden properties do not begin with underscore when step callback is running");t=!0}},complete:function(e){strictEqual(e,n.getLayer(0),"Layer object is passed to complete callback");start()}})})});module("Text API",{setup:f,teardown:l});test("drawText()",function(){var e;n.drawText({layer:!0,name:"text",fontFamily:"sans-serif",fontSize:36,text:"Hello"});e=n.getLayer("text");ok(e.width,"Width is calculated");ok(e.height,"Height is calculated")});test("measureText()",function(){var e;e=n.measureText({fontFamily:"sans-serif",fontSize:36,text:"Hello"});ok(e.width,"Width is calculated");ok(e.height,"Height is calculated")});module("Image API",{setup:f,teardown:l});asyncTest("drawImage()",function(){expect(4);var e=0;n.drawImage({layer:!0,name:"fish",source:"images/fish.jpg",load:function(t){e+=1;if(e===1){strictEqual(n.getLayer("fish"),t,"Layer is passed to callback initially");strictEqual(t.width,220,"Width is calculated");strictEqual(t.height,138,"Height is calculated")}else if(e===2){strictEqual(n.getLayer("fish"),t,"Layer is passed to callback on redraw");start()}}});n.drawLayers()});test("getCanvasImage()",function(){var e,r;e=t.getCanvasImage();strictEqual(e,null,"Returns null for non-canvas elements");e=n.getCanvasImage();strictEqual(e.indexOf("data:image/png;base64,"),0,"Returns data URL of type image/png by default");e=n.getCanvasImage("png");strictEqual(e.indexOf("png"),11,"Returns data URL of type image/png");e=n.getCanvasImage("jpeg");strictEqual(e.indexOf("jpeg"),11,"Returns data URL of type image/jpeg");r=n.getCanvasImage("jpeg",.5);notStrictEqual(e,r,"Returns data URL of type image/jpeg with 50% compression")})})(jQuery);